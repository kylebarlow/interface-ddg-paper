\documentclass[journal=jpcbfk,manuscript=suppinfo]{achemso}
\setkeys{acs}{doi = true}

\usepackage[T1]{fontenc}       % Use modern font encodings
\usepackage[capitalise]{cleveref}
\usepackage{import}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{csvsimple}
\usepackage{longtable}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{minted}
\usepackage{caption}
\usepackage{pdflscape}

\newcommand\ddg{$\Delta\Delta G$}

\usepackage{xr} % Probably not needed for submission
\externaldocument{flex-ddG}

\input{authors-title}

% A listing of the contents of each file supplied as Supporting Information
% should be included. For instructions on what should be included in the
% Supporting Information as well as how to prepare this material for
% publications, refer to the journal's Instructions for Authors.

% The following files are available free of charge.
% \begin{itemize}
% \item Filename: brief description
% \item Filename: brief description
% \end{itemize}

% Supplementary figures:
% \begin{itemize}
% \item \cref{tab:table-mult}
% \item \cref{fig:steps-v-corr}
% \item \cref{tab:table-versions}
% \item \cref{fig:structs-v-corr-id-zemu-12-60000-rscript-simplified-t14}
% \item \cref{fig:structs-v-corr-WildTypeComplex-ddg-monomer-16-003-zemu-2}
% \item \cref{fig:wildtypecomplex-scores-complete}
% \item \cref{fig:spear-corr-rmsd-error}
% \item \cref{fig:t14-mean-ensemble}
% \item \cref{tab:table-ref}
% \item \cref{tab:table-antibodies}
% \item \cref{fig:t14-fits-feats}
% \end{itemize}

\begin{document}

\renewcommand{\thefigure}{S\arabic{figure}}
\setcounter{figure}{0}
\renewcommand{\thetable}{S\arabic{table}}
\setcounter{table}{0}
% \renewcommand{\lstlistingname}{Code Listing}
\renewcommand*{\thepage}{S\arabic{page}}

\subimport*{figs-and-tables/}{table-versions}
\subimport*{figs-and-tables/}{table-temperature}
\clearpage
\input{figs-and-tables/table-by-structure}
\clearpage

%\begin{landscape}
  {\small
    \subimport*{figs-and-tables/}{structs-v-corr-WildTypeComplex-zemu-12-60000-rscript-simplified-t14-underlying-data}
  }
%\end{landscape}
\clearpage

\clearpage
%\begin{landscape}
  {\small
    \subimport*{figs-and-tables/}{structs-v-corr-WildTypeComplex-ddg-monomer-16-003-zemu-2-underlying-data}
  }
%\end{landscape}
\clearpage

\clearpage
%\begin{landscape}
  {\small
    \subimport*{figs-and-tables/}{structs-v-corr-id-zemu-12-60000-rscript-simplified-t14-underlying-data}
  }
%\end{landscape}
\clearpage

{\small
  \subimport*{figs-and-tables/}{steps-v-corr-underlying-data.tex}
}

\subimport*{figs-and-tables/}{table-ref}

\begin{table}
  \begin{tabular}{llrrrr}
\toprule
Prediction Method &     N &    R &  MAE &   FC \\
\midrule
 Flex ddG (Talaris) GAM & \multirow{ 4}{*}{1240} & 0.68 & 0.88 & 0.76 \\
 Flex ddG (REF) GAM & & 0.68 & 0.88 & 0.75  \\
 No backrub control GAM & & 0.62 & 0.93 & 0.75  \\
\bottomrule
\end{tabular}
  \caption[]{
    Performance for GAM-fit predictions on the complete benchmark data set, with Talaris\cite{song_structure-guided_2011,shapovalov_smoothed_2011,omeara_combined_2015} and REF\cite{alford_rosetta_2017} energy functions. Backrub steps = 35000. N = number of cases in the dataset. R = Pearson's R. MAE = Mean Absolute Error. FC = Fraction Correct.
  } \label{tab:table-gam-fit}
\end{table}


\begin{figure}
  \centering
  \includegraphics[width=\textwidth,keepaspectratio]{figures/wildtypecomplex-scores-complete.png}
  \caption{
    Contour plot showing the effect of backrub sampling on the average wild-type complex score, for increasing numbers of averaged models. As the number of averaged models is increased along the x-axis, the average total score of the ensemble of wild-type complex models (shown as colored contours in the body of the plot) also increases, as the wild-type complex models are first sorted according to their total scores and included in the averaged ensemble in order of increasing score.
    As the number of backrub sampling steps at which the ensemble is generated increases (along the y-axis), the total score of an ensemble of any number of models tends to decrease, indicating that flex ddG is able to find lower-energy conformations (as measured by the Rosetta energy function) as the simulation progresses. However, using only the lowest energy models does not produce higher correlations with experimental \ddg\ values, as shown in \cref{fig:structs-v-corr-WildTypeComplex-zemu-12-60000-rscript-simplified-t14}.
    Rosetta scores are in Rosetta Energy Units (REU) using the Rosetta Talaris energy function\cite{song_structure-guided_2011,shapovalov_smoothed_2011,omeara_combined_2015}.
  } \label{fig:wildtypecomplex-scores-complete}
\end{figure}

\subimport*{figs-and-tables/}{structs-v-corr-WildTypeComplex-ddg-monomer-16-003-zemu-2}

\clearpage
  {\small
    \subimport*{figs-and-tables/}{steps-v-corr_ss}
  }
%\end{landscape}
\clearpage

  {\small
    \subimport*{figs-and-tables/}{steps-v-corr_burial}
  }
%\end{landscape}
\clearpage


\subimport*{figs-and-tables/}{structs-v-corr-id-zemu-12-60000-rscript-simplified-t14}

\begin{figure}
  \centering
  \includegraphics[width=0.6\textwidth,keepaspectratio]{figures/t14-mean-ensemble-error-50k.png}
  \caption{
    The average pairwise ensemble RMSD for each ensemble of 50 models is shown versus increasing backrub sampling steps.
    Average pairwise RMSD is computed on all atoms in residues selected as neighborhood pivot residues.
    To calculate pairwise RMSD, this selection of atoms is superimposed onto their positions in the last output model in the backrub trajectory before pairwise RMSDs are computed.
    Pairwise ensemble RMSD increases with increasing backrub sampling steps, indicating that the diversity of sampled models (as measured by RMSD) continues to increase past the point around 30k-35k sampling steps where correlation with experimental \ddg\ values levels out.
    RMSD shown is calculated for 1216 out of 1240 of the total points in the dataset.
  } \label{fig:t14-mean-ensemble} % TODO y axis: mean of pairwise ensemble RMSDs, and remove everything other than complete
\end{figure}

%% HERE

\begin{figure}
  \includegraphics[width=\textwidth,keepaspectratio]{figures/zemu-sigmoid2-corrs-supp.png}
  \caption[]{
    Experimentally determined $\Delta\Delta G$ values (x-axis) versus predictions.
    The error bars in gray represent the range from minimum to maximum fit predicted \ddg\ value for the 1000 sampled GAM (Generalized Additive Model) models.
    A line of best fit is shown.
    \textbf{(a)}: standard Rosetta output (non-fitted REF predictions) vs. experimental \ddg\ values.
    \textbf{(b)}: GAM flex ddG predictions vs. experimental data.
    This plot is analogous to \cref{fig:t14-fit-scatter-main}b in the main text, except that GAM scores are refit from values in Rosetta Energy Units (REU) using the Rosetta REF\cite{alford_rosetta_2017} energy function (instead of Talaris\cite{song_structure-guided_2011,shapovalov_smoothed_2011,omeara_combined_2015}).
  } \label{fig:t14-fit-scatter-supp}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth,keepaspectratio]{figures/zemu-sigmoid2-tal-feats.png}
  \caption[Sigmoid fit Rosetta score function terms]{
    Sigmoid functions resulting from application of unbiased logistic scaling to individual Rosetta score terms (generated using the flex ddG protocol and the Talaris energy function\cite{song_structure-guided_2011,shapovalov_smoothed_2011,omeara_combined_2015}) in a generalized additive model. Extreme values for most score terms are downweighted, except for long-range hydrogen bond interactions between backbone atoms, which only make minor contributions (hbond\_lr\_bb). % TODO add equation parameters as new table
  } \label{fig:t14-fits-feats}
\end{figure}

\begin{figure}
  \includegraphics[width=\textwidth,keepaspectratio]{figures/tal-GAM-terms-mpl.png}
  \caption[]{
    Total \ddg\ predictions and partial Rosetta score terms (Talaris energy function\cite{song_structure-guided_2011,shapovalov_smoothed_2011,omeara_combined_2015}). On the far left, total scores for the original Rosetta predictions are shown in green alongside GAM-fit predictions in orange and the experimentally determined values in blue. On the far right, the error ($\Delta\Delta G_{predicted} - \Delta\Delta G_{experimental}$) is shown. Intermediate strips show the 7 partial Rosetta score terms (fa\_sol, hbond\_sc, hbond\_bb\_sc, hbond\_lr\_bb, fa\_rep, fa\_elec, and fa\_atr) which together equal the total \ddg\ score on the far left.
    Points shown are filtered from the complete prediction set according to the following criteria: neutral mutations are removed (-1.0 $<$ experimental \ddg\ or Rosetta predicted \ddg\ score $<$ 1.0). Also removed are points where the absolute value of the error of the original Rosetta prediction is less than 2.0
  } \label{fig:tal-GAM-terms-mpl}
\end{figure}

\clearpage

\renewcommand\tablename{Dataset}
\setcounter{table}{0}

{ \small
\csvreader[
longtable=|c|c|c|p{8cm}|r|,
table head=\caption{Curated ZEMu dataset with experimental \ddg\ values}\label{dst:zemu-filtered}\\\hline
ID & PDB & Res. & Mutations & \ddg\\\hline
\endhead\hline\endfoot,
% \csvlinetotablerow\\\hline
% \endfirsthead\hline
% \csvlinetotablerow\\\hline
% \endhead\hline
% \endfoot,
]
{figures/table-zemu-filtered.csv}
{1=\DataSetID,2=\PDBFileID,3=\Resolution,4=\Mutations,5=\ExperimentalDDG}
{\DataSetID & \PDBFileID & \Resolution & \Mutations & \ExperimentalDDG}
}

\clearpage

\captionof{listing}{
  Flex ddg Rosetta Script implementation
  \label{lst:ddg-script}
}
\inputminted[
linenos=true,
% frame=single,
breaklines
]
{xml}
{listings/ddG-backrub.xml}

\clearpage

\bibliography{references}

\end{document}
